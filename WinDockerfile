FROM ghcr.io/beamable/ue4-full:5.3.2 as builder

# use --build-arg BUILD_TYPE=-server in docker build to set it to be server build
ARG BUILD_TYPE=" "
ENV BUILD_ARG=${BUILD_TYPE}

# by default it passes all maps, you can pass value `--build-arg MAP_ARG=-map=DefaultMap+BeamBackendTests` to override it
ARG MAP_ARG=-allmaps
ENV MAP_ARG=${MAP_ARG}
ARG CLIENT_CONFIG=Shipping
ENV CLIENT_CONFIG=${CLIENT_CONFIG}
ARG SERVER_CONFIG=Shipping
ENV SERVER_CONFIG=${SERVER_CONFIG}

WORKDIR C:\\

# Copy your Unreal project files into the Docker image
COPY --chown=ue4:ue4 . C:\\Project
WORKDIR C:\\Project

RUN C:\UnrealEngine\Engine\Binaries\ThirdParty\DotNet\6.0.302\windows\dotnet.exe C:\UnrealEngine\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.dll -ProjectFiles -UsePrecompiled -Game "C:/Project/BeamableUnreal.uproject"

# RUN .\beam_init_repo.bat

RUN C:\UnrealEngine\Engine\Build\BatchFiles\RunUAT.bat BuildCookRun -project=C:\Project\BeamableUnreal.uproject \
-utf8output \
-platform=Win64 \
-clientconfig=%CLIENT_CONFIG% \
-serverconfig=%SERVER_CONFIG% %BUILD_ARG% \
-noP4 -nodebuginfo %MAP_ARG% \
-cook -build -stage -prereqs -pak -archive \
-archivedirectory=C:\Project\PackagedProject